<!-- Realizado por Alexandra Hurtado -->
{% extends "base.html" %}

{% block title %}Lista de Pedidos{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark">Lista de Pedidos</h2>
        {% if user.is_staff %}
            <a href="{% url 'pedidos:exportar_pedidos_pagados' %}" 
               class="btn rounded-pill fw-semibold"
               style="background: linear-gradient(90deg, #f5d442, #f0b90b); border: none; color: #3a2e00;">
                Descargar pedidos pagados
            </a>
        {% endif %}
    </div>

    <!-- Tabla de pedidos -->
    <div class="table-responsive shadow-sm rounded-4 border-0">
        <table class="table align-middle text-center mb-0" 
               style="background: #fffdf3; border-radius: 1rem; overflow: hidden;">
            <thead style="background: linear-gradient(90deg, #fff7c2, #ffec8b); color: #3a2e00;">
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Dirección</th>
                    <th>Productos</th>
                    <th>Fecha</th>
                    <th>Estado del Pedido</th>
                    <th>Estado del Pago</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for pedido in pedidos %}
                <tr>
                    <td class="fw-semibold">{{ pedido.id }}</td>
                    <td>{{ pedido.usuario }}</td>
                    <td>{{ pedido.usuario.direccion }}</td>
                    <td class="text-start">
                        {% for item in pedido.items.all %}
                            <span class="d-block small">{{ item.producto }} (x{{ item.cantidad }})</span>
                        {% endfor %}
                    </td>
                    <td>{{ pedido.fecha }}</td>

                    <!-- Estado del pedido -->
                    <td>
                        <span class="badge rounded-pill px-3 py-2 text-dark" 
                              style="background-color: #fff7cc; border: 1px solid #f0b90b;">
                            {{ pedido.get_estado_display }}
                        </span>
                    </td>

                    <!-- Estado del pago con color dinámico -->
                    <td>
                        {% if pedido.pago %}
                            {% if pedido.pago.estado|lower == "pendiente" %}
                                <span class="fw-semibold" style="color: #f7a500;">{{ pedido.pago.estado }}</span>
                            {% elif pedido.pago.estado|lower == "pagado" or pedido.pago.estado|lower == "completado" %}
                                <span class="fw-semibold text-success">{{ pedido.pago.estado }}</span>
                            {% else %}
                                <span class="fw-semibold text-muted">{{ pedido.pago.estado }}</span>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Sin registro</span>
                        {% endif %}
                    </td>

                    <td class="fw-bold">${{ pedido.total }}</td>

                    <!-- Acciones -->
                    <td>
                        {% if user.is_superuser %}
                            <form method="post" action="{% url 'pedidos:cambiar_estado_pedido' pedido.id 'dummy' %}" style="display:inline;">
                                {% csrf_token %}
                                <select name="nuevo_estado"
                                        onchange="this.form.action=this.form.action.replace('dummy', this.value); this.form.submit();"
                                        class="form-select form-select-sm rounded-pill"
                                        style="border: 1px solid #f5d442; background-color: #fffdf3; color: #3a2e00;">
                                    <option disabled selected>Cambiar</option>
                                    {% for valor, label in pedido.ESTADOS %}
                                        <option value="{{ valor }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                        {% else %}
                            <span class="text-muted">No disponible</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center py-4 text-muted">No hay pedidos registrados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

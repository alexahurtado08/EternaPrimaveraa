<!-- Realizado por Alexandra Hurtado -->
{% extends "base.html" %}

{% block title %}Lista de Pedidos{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Lista de Pedidos</h2>

    {% if user.is_staff %}
        <a href="{% url 'pedidos:exportar_pedidos_pagados' %}" class="btn btn-outline-success mb-3">
            Descargar pedidos pagados en Excel
        </a>
    {% endif %}

    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Direcci√≥n</th>
                <th>Productos</th> 
                <th>Fecha</th>
                <th>Estado del Pedido</th>
                <th>Estado del Pago</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for pedido in pedidos %}
            <tr>
                <td>{{ pedido.id }}</td>
                <td>{{ pedido.usuario }}</td>
                <td>{{ pedido.usuario.direccion }}</td>
                <td>
                    {% for item in pedido.items.all %}
                        {{ item.producto }} (x{{ item.cantidad }})<br>
                    {% endfor %}
                </td>

                <td>{{ pedido.fecha }}</td>
                <td>{{ pedido.get_estado_display }}</td>
                <td>
                    {% if pedido.pago %}
                        {{ pedido.pago.estado }}
                    {% else %}
                        <span class="text-muted">Sin registro</span>
                    {% endif %}
                </td>
                <td>${{ pedido.total }}</td>
                <td>
                    {% if user.is_superuser %}
                        <form method="post" action="{% url 'pedidos:cambiar_estado_pedido' pedido.id 'dummy' %}" style="display:inline;">
                            {% csrf_token %}
                            <select name="nuevo_estado"
                                    onchange="this.form.action=this.form.action.replace('dummy', this.value); this.form.submit();"
                                    class="form-select form-select-sm d-inline w-auto">
                                <option disabled selected>Cambiar estado</option>
                                {% for valor, label in pedido.ESTADOS %}
                                    <option value="{{ valor }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">No hay pedidos registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}